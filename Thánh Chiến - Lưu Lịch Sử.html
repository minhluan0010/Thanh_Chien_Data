<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Th√°nh Chi·∫øn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS ƒë·ªÉ l√†m n·ªïi b·∫≠t Top 3 */
        .top-1 {
            background-color: #f18704 !important; /* V√†ng nh·∫°t (d√πng !important ƒë·ªÉ ghi ƒë√®) */
            font-weight: 900; /* ƒê·∫≠m nh·∫•t */
            color: #fff !important;
        }
        .top-2 {
            background-color: #44b0ef !important; /* B·∫°c nh·∫°t */
            font-weight: 700; /* ƒê·∫≠m v·ª´a */
            color: #fff !important;
        }
        .top-3 {
            background-color: #a8e799 !important; /* ƒê·ªìng nh·∫°t */
            font-weight: 700; /* ƒê·∫≠m v·ª´a */
            color: #000000 !important;
        }
        /* Chi·ªÅu cao t·ªëi ƒëa cho c√°c b·∫£ng */
        .table-container {
            max-height: 65vh;
            overflow-y: auto;
        }
		.linhthach {
			color: #0087ff;
			font-weight: bold;
		}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-4">
        
        <header class="mb-4 p-4 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-center text-blue-700">B·∫£ng Tin Th√°nh Chi·∫øn</h1>
            <div class="text-center text-lg mt-2">
                <span class="font-semibold">Th·ªùi gian m√°y ch·ªß:</span>
                <span id="realtime-clock" class="font-mono font-bold text-gray-900">--:--:--</span>
            </div>
            <div class="text-center text-sm mt-1">
                <span class="font-semibold">Tr·∫°ng th√°i:</span>
                <span id="refresh-status" class="font-mono text-gray-600">ƒêang kh·ªüi t·∫°o...</span>
            </div>
        </header>

        <div class="flex flex-col-reverse lg:flex-row gap-4">

            <main class="w-full lg:w-2/3 space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h2 id="contribution-title" class="text-2xl font-bold text-center mb-4">ƒê√≥ng G√≥p Tr·∫≠n Hi·ªán T·∫°i Cho K√®o (--:00)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div>
                            <h3 class="text-xl font-semibold text-sky-600 mb-2">
                                üòá Phe Angel
                                <span id="angel-gems" class="linhthach"></span>
                            </h3>
                            <div class="font-bold mb-2">T·ªïng V√†ng: <span id="angel-total" class="text-sky-600">0</span></div>
                            <div class="table-container border rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="p-2 text-left">T√™n</th>
                                            <th class="p-2 text-right">V√†ng</th>
                                            <th class="p-2 text-left">Guild</th>
                                        </tr>
                                    </thead>
                                    <tbody id="angel-list">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-red-600 mb-2">
                                üòà Phe Devil
                                <span id="devil-gems" class="linhthach"></span>
                            </h3>
                            <div class="font-bold mb-2">T·ªïng V√†ng: <span id="devil-total" class="text-red-600">0</span></div>
                            <div class="table-container border rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="p-2 text-left">T√™n</th>
                                            <th class="p-2 text-right">V√†ng</th>
                                            <th class="p-2 text-left">Guild</th>
                                        </tr>
                                    </thead>
                                    <tbody id="devil-list">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <aside class="w-full lg:w-1/3">
                <div class="bg-white p-4 rounded-lg shadow-lg sticky top-4">
                    <h2 class="text-2xl font-bold text-center mb-4">L·ªãch S·ª≠ Th√°nh Chi·∫øn (24h)</h2>
                    <div class="text-center mb-2 space-x-4">
                        <span class="font-bold">üòá Angel: <span id="angel-wins" class="text-sky-600">0</span> th·∫Øng</span>
                        <span class="font-bold">üòà Devil: <span id="devil-wins" class="text-red-600">0</span> th·∫Øng</span>
                    </div>
                    <div class="text-center mb-2 space-x-4 text-sm border-t pt-2 mt-2">
                        <span class="font-bold">T·ªïng V√†ng (A): <span id="angel-total-gold" class="text-sky-600">0</span></span>
                        <span class="font-bold">T·ªïng V√†ng (D): <span id="devil-total-gold" class="text-red-600">0</span></span>
                    </div>
                    <div class="table-container border rounded-lg overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">Ng√†y</th>
                                    <th class="p-2 text-left">Gi·ªù</th>
                                    <th class="p-2 text-left">ƒê·ªôi Th·∫Øng</th>
                                    <th class="p-2 text-right">T·ªïng V√†ng</th>
                                </tr>
                            </thead>
                            <tbody id="history-list">
                                </tbody>
                        </table>
                    </div>
                </div>
            </aside>
        </div>

        <div class="mt-4 bg-white p-4 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-center">Th·ªëng K√™ L·ªãch S·ª≠ (Thu th·∫≠p t·ª± ƒë·ªông)</h2>
                </div>
            <div class="max-h-[80vh] overflow-auto border rounded-lg">
                <table class="w-full text-sm min-w-[1000px]">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">STT</th>
                            <th class="p-2 text-left">ID Tr·∫≠n</th>
                            <th class="p-2 text-left">Ng√†y</th>
                            <th class="p-2 text-left">Gi·ªù</th>
                            <th class="p-2 text-right">V√†ng Ti√™n</th>
                            <th class="p-2 text-right">V√†ng Ma</th>
                            <th class="p-2 text-right">LT Tr·ª´ Ti√™n</th>
                            <th class="p-2 text-right">LT Tr·ª´ Ma</th>
                            <th class="p-2 text-left">Phe Th·∫Øng</th>
                            <th class="p-2 text-right">V√†ng Th·∫Øng</th>
                        </tr>
                    </thead>
                    <tbody id="statistics-list">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // PH·∫¶N 1: C·∫§U H√åNH API (CHO XEM TR·ª∞C TI·∫æP)
        // =================================================================
        
        const API_HISTORY_URL = "https://cmangax8.com/api/data?data=game_data"; 
        const API_ANGEL_URL = "https://cmangax8.com/api/score_list?type=ad_angel&limit=1000"; 
        const API_DEVIL_URL = "https://cmangax8.com/api/score_list?type=ad_devil&limit=1000";
        const API_GEMS_URL = "https://cmangax8.com/api/ad_request_remain"; 

        // === M·ªöI: ƒê∆∞·ªùng d·∫´n ƒë·∫øn file data do GitHub Action t·∫°o ra ===
        const GITHUB_HISTORY_URL = 'history.json';

        // =================================================================
        // PH·∫¶N 2: LOGIC X·ª¨ L√ù (TR·ª∞C TI·∫æP)
        // =================================================================

        let autoRefreshInterval = null; // Bi·∫øn gi·ªØ b·ªô ƒë·∫øm 30s
        let isRefreshing = false;       // C·ªù ƒë√°nh d·∫•u tr·∫°ng th√°i refresh

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const clockElement = document.getElementById("realtime-clock");
        const statusElement = document.getElementById("refresh-status");
        const contributionTitle = document.getElementById("contribution-title");
        const angelList = document.getElementById("angel-list");
        const devilList = document.getElementById("devil-list");
        const angelTotal = document.getElementById("angel-total");
        const devilTotal = document.getElementById("devil-total");
        const historyList = document.getElementById("history-list");
        const angelWins = document.getElementById("angel-wins");
        const devilWins = document.getElementById("devil-wins");
        const angelGems = document.getElementById("angel-gems");
        const devilGems = document.getElementById("devil-gems");
        const angelTotalGold = document.getElementById("angel-total-gold");
        const devilTotalGold = document.getElementById("devil-total-gold");
        const statisticsList = document.getElementById("statistics-list");


        // --- H√†m ch·∫°y khi t·∫£i trang ---
        document.addEventListener("DOMContentLoaded", () => {
            // Ch·∫°y ƒë·ªìng h·ªì
            setInterval(clockManager, 1000); 
            
            // T·∫£i d·ªØ li·ªáu TR·ª∞C TI·∫æP (cho 2 c·ªôt tr√™n)
            loadAllData();

            // M·ªöI: T·∫£i b·∫£ng th·ªëng k√™ t·ª´ file history.json
            loadStatisticsTable();
        });
        
        // --- H√†m t·∫£i T·∫§T C·∫¢ d·ªØ li·ªáu (L·ªãch s·ª≠ + ƒê√≥ng g√≥p) ---
        function loadAllData() {
            console.log("ƒêang t·∫£i l·∫°i d·ªØ li·ªáu tr·ª±c ti·∫øp...");
            statusElement.textContent = "ƒêang t·∫£i d·ªØ li·ªáu tr·ª±c ti·∫øp...";
            fetchHistory();
            fetchContributions();
        }

        // --- H√†m t·∫£i L·ªãch s·ª≠ (API 1) ---
        // *** ƒê√É S·ª¨A ƒê·ªîI: X√≥a b·ªè ph·∫ßn g·ªçi localStorage ***
        async function fetchHistory() {
            try {
                const response = await fetch(API_HISTORY_URL); 
                if (!response.ok) throw new Error(`L·ªói t·∫£i l·ªãch s·ª≠: ${response.status}`);
                
                const data = await response.json();
                
                // 1. Hi·ªÉn th·ªã l·ªãch s·ª≠ (nh∆∞ c≈©)
                displayHistory(data.angel_devil.history); 

                // 2. (ƒê√É X√ìA) Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t localStorage n·ªØa

            } catch (error) {
                console.error(error);
                historyList.innerHTML = `<tr><td colspan="4" class="p-2 text-red-500 text-center">L·ªói t·∫£i l·ªãch s·ª≠: ${error.message}</td></tr>`;
            }
        }

        // --- H√†m t·∫£i ƒê√≥ng g√≥p (API 2 & 3 & 4) (Kh√¥ng thay ƒë·ªïi) ---
        async function fetchContributions() {
            console.log(`[${new Date().toLocaleTimeString()}] ƒêang c·∫≠p nh·∫≠t ƒëi·ªÉm...`);
            statusElement.textContent = `ƒêang c·∫≠p nh·∫≠t ƒëi·ªÉm... (${new Date().toLocaleTimeString()})`;
            
            try {
                const [angelResponse, devilResponse, gemsResponse] = await Promise.all([
                    fetch(API_ANGEL_URL),
                    fetch(API_DEVIL_URL),
                    fetch(API_GEMS_URL)
                ]);

                if (!angelResponse.ok) throw new Error(`L·ªói t·∫£i Angel: ${angelResponse.status}`);
                if (!devilResponse.ok) throw new Error(`L·ªói t·∫£i Devil: ${devilResponse.status}`);
                if (!gemsResponse.ok) throw new Error(`L·ªói t·∫£i Gems: ${gemsResponse.status}`); 

                const angelData = await angelResponse.json();
                const devilData = await devilResponse.json();
                const gemsData = await gemsResponse.json(); 

                displayContributions(angelData, devilData, gemsData); 
                statusElement.textContent = `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi l√∫c: ${new Date().toLocaleTimeString()}`;
            } catch (error)
            {
                console.error(error);
                statusElement.textContent = `L·ªói c·∫≠p nh·∫≠t: ${error.message}`;
            }
        }
        
        // --- H√†m hi·ªÉn th·ªã L·ªãch s·ª≠ (Kh√¥ng thay ƒë·ªïi) ---
        function displayHistory(historyData) {
            historyList.innerHTML = "";
            let angelWinCount = 0;
            let devilWinCount = 0;
            let totalAngelGold = 0;
            let totalDevilGold = 0;

            const processedHistory = Object.keys(historyData).map(hourKey => {
                const match = historyData[hourKey];
                return {
                    hour: hourKey,
                    team: match.team,
                    total: match.total,
                    time: new Date(match.time) 
                };
            });

            processedHistory.sort((a, b) => b.time - a.time);

            processedHistory.forEach(match => {
                const row = document.createElement("tr");
                let teamClass = "";
                let teamIcon = "";

                if (match.team === "angel") {
                    teamClass = "text-sky-600";
                    teamIcon = "üòá";
                    angelWinCount++;
                    totalAngelGold += match.total;
                } else {
                    teamClass = "text-red-600";
                    teamIcon = "üòà";
                    devilWinCount++;
                    totalDevilGold += match.total;
                }

                const matchDate = match.time;
                const dateString = `${String(matchDate.getDate()).padStart(2, '0')}/${String(matchDate.getMonth() + 1).padStart(2, '0')}`;
                const hourString = `${String(matchDate.getHours()).padStart(2, '0')}:00`;

                row.innerHTML = `
                    <td class="p-2 font-mono">${dateString}</td>
                    <td class="p-2 font-mono">${hourString}</td>
                    <td class="p-2 font-bold ${teamClass}">${teamIcon} ${match.team}</td>
                    <td class="p-2 text-right font-mono">${formatNumber(match.total)}</td>
                `;
                historyList.appendChild(row);
            });

            angelWins.textContent = angelWinCount;
            devilWins.textContent = devilWinCount;
            angelTotalGold.textContent = formatNumber(totalAngelGold);
            devilTotalGold.textContent = formatNumber(totalDevilGold);
        }

        // --- H√†m hi·ªÉn th·ªã ƒê√≥ng g√≥p (Kh√¥ng thay ƒë·ªïi) ---
        function displayContributions(angelData, devilData, gemsData) {
            
            if (gemsData && gemsData.devil > 0) {
                angelGems.textContent = `-${formatNumber(gemsData.devil)} linh th·∫°ch`;
                devilGems.textContent = `0 linh th·∫°ch`;
            } else if (gemsData && gemsData.angel > 0) {
                angelGems.textContent = `0 linh th·∫°ch`;
                devilGems.textContent = `-${formatNumber(gemsData.angel)} linh th·∫°ch`;
            } else {
                angelGems.textContent = `0 linh th·∫°ch`;
                devilGems.textContent = `0 linh th·∫°ch`;
            }

            // 1. X·ª≠ l√Ω phe Angel
            let totalAngelScore = 0;
            angelList.innerHTML = "";
            const processedAngel = processContributionList(angelData);
            processedAngel.forEach((item, index) => {
                totalAngelScore += item.score;
                const row = document.createElement("tr");
                row.className = getTopClass(index);
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2 text-right">${formatNumber(item.score)}</td>
                    <td class="p-2">${item.guild}</td>
                `;
                angelList.appendChild(row);
            });
            angelTotal.textContent = formatNumber(totalAngelScore)+" V√†ng";

            // 2. X·ª≠ l√Ω phe Devil
            let totalDevilScore = 0;
            devilList.innerHTML = "";
            const processedDevil = processContributionList(devilData);
            processedDevil.forEach((item, index) => {
                totalDevilScore += item.score;
                const row = document.createElement("tr");
                row.className = getTopClass(index);
                row.innerHTML = `
                    <td class="p-2">${item.name}</td>
                    <td class="p-2 text-right">${formatNumber(item.score)}</td>
                    <td class="p-2">${item.guild}</td>
                `;
                devilList.appendChild(row);
            });
            devilTotal.textContent = formatNumber(totalDevilScore)+" V√†ng";
        }
        
        // --- H√†m ph·ª•: "L√†m ph·∫≥ng" v√† s·∫Øp x·∫øp danh s√°ch ƒë√≥ng g√≥p (Kh√¥ng thay ƒë·ªïi) ---
        function processContributionList(data) {
            if (!Array.isArray(data)) {
                console.error("D·ªØ li·ªáu ƒë√≥ng g√≥p kh√¥ng ph·∫£i l√† m·∫£ng:", data);
                return [];
            }
            return data.map(item => {
                const info = JSON.parse(item.info);
                return {
                    name: info.name,
                    score: parseInt(item.score, 10),
                    guild: info.guild ? info.guild.name : "N/A"
                };
            }).sort((a, b) => b.score - a.score); 
        }

        // --- H√†m ph·ª•: L·∫•y class CSS cho Top 3 (Kh√¥ng thay ƒë·ªïi) ---
        function getTopClass(index) {
            if (index === 0) return 'top-1';
            if (index === 1) return 'top-2';
            if (index === 2) return 'top-3';
            return '';
        }

        // --- H√†m ph·ª•: ƒê·ªãnh d·∫°ng s·ªë (Kh√¥ng thay ƒë·ªïi) ---
        function formatNumber(num) {
            if (typeof num !== 'number') return num; 
            return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
        }

        // =================================================================
        // PH·∫¶N 3: ƒê·ªíNG H·ªí H·∫∏N GI·ªú
        // *** ƒê√É S·ª¨A ƒê·ªîI: X√≥a b·ªè logic l∆∞u tr·ªØ l√∫c 59:35 ***
        // =================================================================
        function clockManager() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì
            clockElement.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ tr·∫≠n
            const nextHour = String((now.getHours() + 1) % 24).padStart(2, '0');
            contributionTitle.textContent = `ƒê√≥ng G√≥p Tr·∫≠n Hi·ªán T·∫°i (${nextHour}:00)`;
            
            // --- Logic T·ª± ƒë·ªông Refresh ---

            // 1. K√≠ch ho·∫°t khi ƒë·∫øn xx:55:00 (Gi·ªØ nguy√™n)
            if (minutes >= 55 && !isRefreshing) {
                console.log("!!! ƒê√É ƒê·∫æN 55p. B·∫ÆT ƒê·∫¶U REFRESH 30s/L·∫¶N !!!");
                isRefreshing = true;
                
                fetchContributions(); 
                autoRefreshInterval = setInterval(fetchContributions, 30000); 
                
                statusElement.textContent = "ƒêANG C·∫¨P NH·∫¨T LI√äN T·ª§C (30s/l·∫ßn)";
            }

            // 2. (ƒê√É X√ìA) Logic l∆∞u d·ªØ li·ªáu l√∫c 59:35

            // 3. T·∫Øt khi qua gi·ªù m·ªõi (xx:00:30)
            // *** ƒê√É S·ª¨A ƒê·ªîI: X√≥a c·ªù 'hasSavedThisHour' ***
            if (minutes === 0 && seconds >= 30 && isRefreshing) {
                console.log("!!! ƒê√É QUA GI·ªú M·ªöI. D·ª™NG REFRESH 30s. T·∫¢I L·∫†I T·∫§T C·∫¢ !!!");
                
                isRefreshing = false;
                clearInterval(autoRefreshInterval); 
                
                // T·∫£i l·∫°i t·∫•t c·∫£ (quan tr·ªçng: ƒë·ªÉ c·∫≠p nh·∫≠t L·ªäCH S·ª¨)
                loadAllData();
                
                // M·ªöI: T·∫£i l·∫°i b·∫£ng th·ªëng k√™ ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t
                loadStatisticsTable();
            }
        }

        // =================================================================
        // PH·∫¶N 4: H√ÄM M·ªöI (ƒê·ªåC T·ª™ GITHUB)
        // =================================================================

        /**
         * M·ªöI: T·∫£i v√† hi·ªÉn th·ªã b·∫£ng th·ªëng k√™ t·ª´ file `history.json` tr√™n GitHub.
         */
        async function loadStatisticsTable() {
            console.log("ƒêang t·∫£i b·∫£ng th·ªëng k√™ t·ª´ file history.json...");
            statisticsList.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>`;

            try {
                // Th√™m cache-busting query string ƒë·ªÉ lu√¥n l·∫•y file m·ªõi nh·∫•t
                const response = await fetch(`${GITHUB_HISTORY_URL}?t=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`L·ªói t·∫£i file ${GITHUB_HISTORY_URL}: ${response.statusText}`);
                }
                
                const storedHistory = await response.json();
                
                // D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp b·ªüi script, nh∆∞ng ta c·ª© s·∫Øp x·∫øp l·∫°i
                storedHistory.sort((a, b) => b.STT - a.STT);

                statisticsList.innerHTML = ""; // X√≥a d√≤ng "ƒêang t·∫£i"

                if (storedHistory.length === 0) {
                    statisticsList.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c thu th·∫≠p.</td></tr>`;
                    return;
                }

                storedHistory.forEach(rec => {
                    const row = document.createElement("tr");
                    const winnerClass = rec.PheChienThang === 'angel' ? 'text-sky-600' : (rec.PheChienThang === 'devil' ? 'text-red-600' : '');
                    
                    row.innerHTML = `
                        <td class="p-2 font-mono">${rec.STT}</td>
                        <td class="p-2 font-mono">${rec.ID_Battle}</td>
                        <td class="p-2 font-mono">${rec.Ngay}</td>
                        <td class="p-2 font-mono">${rec.Gio}</td>
                        <td class="p-2 text-right font-mono text-sky-600">${formatNumber(rec.TongVangTien)}</td>
                        <td class="p-2 text-right font-mono text-red-600">${formatNumber(rec.TongVangMa)}</td>
                        <td class="p-2 text-right font-mono linhthach">-${formatNumber(rec.LinhThachTien)}</td>
                        <td class="p-2 text-right font-mono linhthach">-${formatNumber(rec.LinhThachMa)}</td>
                        <td class="p-2 font-bold ${winnerClass}">${rec.PheChienThang || 'Ch∆∞a c√≥'}</td>
                        <td class="p-2 text-right font-mono font-bold ${winnerClass}">${rec.TongVangThang > 0 ? formatNumber(rec.TongVangThang) : 'N/A'}</td>
                    `;
                    statisticsList.appendChild(row);
                });

            } catch (error) {
                console.error("L·ªói khi t·∫£i b·∫£ng th·ªëng k√™:", error);
                statisticsList.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-red-500">L·ªói t·∫£i file th·ªëng k√™: ${error.message}</td></tr>`;
            }
        }
    </script>
</body>
</html>